# Daily Brief Intel BI — v1.4 (Design Freeze)

This document is the **contract** for implementation.  
All implementation PRs must remain consistent with v1.4. If you need to deviate, you must:
1) update/add an ADR,
2) update the Traceability Matrix,
3) then implement.

---

## 1. Business objective and value

### Primary objective
Support **daily** decision-making for:
- Recruiting (Engineer / Sales / Marketing)
- Recruiting (New Graduate / Mid-career)
- Recruiting Web Marketing

### Core value delivered every morning
- A Daily Brief that surfaces **what matters today** with evidence links.
- Monitoring of competitors / major HR players / key platforms / government agencies.
- Change detection: important news and KPI shifts, presented in a short, actionable format.

---

## 2. Scope boundaries (Do / Don’t)

### Do
- Treat **Japan and global (English)** sources as first-class inputs (same pipeline design).
- Collect and unify:
  - **News items** (publicly accessible)
  - **Indicators** (statistics / index data)
- UI outputs are **Title + Summary + Link** only.
- Daily scheduled run:
  - Default: **07:00 JST**
  - Must be configurable (time and future multiple schedules)
- Manual run:
  - Must exist (operator role)
- Local-first persistence:
  - DuckDB as the primary store
  - Auditability and run lineage are mandatory
- All key variability must be config-driven via `config/*.yml`:
  - sources, watchlist, geo, schedule, retention, scoring, alerts, series

### Don’t
- Do not target membership-only / login-required / high redistribution-restriction sources.
- Do not store or display full article bodies in the UI.
- Do not depend entirely on existing BI tools for core value.
  - The system may expose SQL views/exports later for BI connectivity.

---

## 3. Users and authorization

In the current MVP, the admin credential maps to the operator role; admin is not a distinct role yet.

### Users
- Internal staff users (no public users)

### Roles (minimum)
- `viewer`: read-only access to Daily Brief
- `operator`: manual run and exports (future ops features)

### Access policy
- `/daily`: authenticated user (viewer or operator)
- `/run/manual`: operator only
- `/exports/*`: operator only

---

## 4. Global constraints (non-negotiable)

1) **UI safety contract**  
   UI displays **Title + Summary + Link** only.

2) **Compliance boundary**  
   Exclude sources that require authentication or strongly forbid redistribution.

3) **Config as contract**  
   No hard-coded target sources or business rules in code.  
   Configuration is validated before execution.

4) **Auditability and explainability**  
   Store run lineage and evidence needed for decision-making:
   - run_id and per-source status
   - alert reasons
   - evidence links
   - explain_json for computed results

5) **Operational robustness**  
   - External sources are assumed to break.
   - Partial failures are acceptable.
   - Retry, locking, and clear run status are mandatory.

6) **Local-first operations**  
   Start local. Ensure a clean future path to cloud or BI connectivity.

7) **Geo rollup default**  
   Default geo: `tokyo_metro = Tokyo + Kanagawa + Chiba + Saitama`.  
   Additional geo rollups can be added later via config.

8) **Watchlist categories**  
   Manage watchlist by 4 categories:
   - competitor
   - hr_major
   - platform
   - government  
   Start with no hard limits; allow future limits via config.

---

## 5. Architecture (v1.4)

### UI
- FastAPI + Jinja2 + HTMX
- Purpose: operational control, audit-friendly display, lightweight SSR

### Storage
- DuckDB as primary local store
- Parquet/exports optional later
- Raw/audit snapshots where needed (with secret-safe handling)

### Execution model
- Every pipeline run has a unique `run_id` (UUID)
- Run lifecycle is persisted:
  - started_at, ended_at, status, run_mode
  - per-source statuses and errors

### Pipeline separation
- Ingest: gather news/indicators
- Enrich: normalize, dedupe, compute summaries (no body display)
- Index: compute daily indices/metrics
- Alert: generate P1/P2 alerts with evidence
- Present: UI and exports from persisted data

### Fail-safe principles
- Source-level failure isolation
- Retry with bounded attempts
- Concurrency control via run lock
- Secrets in env/.env, never logged or committed

---

## 6. Data concepts (high-level)

Minimum concept set (tables may evolve, but concepts are fixed):
- `run` (fact_run): run_id, timestamps, mode, status
- `source_run` (fact_source_run): run_id + source_id statuses
- `news_items`: title, summary, url, published_at, source_id, dedupe hash
- `series_points`: series_key, period, value, unit, geo_rollup, metadata
- `watch_mentions`: watch entity matches with provenance
- `alerts`: type, severity, reason, evidence links, computed_json
- `daily_index`: derived indices plus explain_json

Explainability contract:
- Every computed KPI/alert must be explainable from stored inputs and explain_json.

---

## 7. UI screens (v1.4)

### `/daily`
Daily Brief showing:
- Latest successful run context (run_id, time)
- Alerts (P1/P2) with evidence links
- Index matrix (role × career × geo rollup)
- Top changes (topics / watch mentions)

### `/run/manual`
Manual execution control (operator-only)

### `/exports/*`
Exports (operator-only), e.g. alerts JSON/CSV

### `/login`
Session-based login

---

## 8. Operations and quality

### Quality gates
- `ruff` + `pytest` must pass for every PR

### Operational features (required over time)
- TTL / retention default 30 days, configurable
- Backup / restore path (daily snapshot)
- Ops visibility: per-source failures, run status, missing series, etc.

---

## 9. Drift policy
Any change that impacts:
- purpose/decisions,
- functions,
- stored fields or schema,
- UI screens/behavior,
must be reflected in:
1) Traceability Matrix update,
2) ADR update (if architectural),
before implementation.
